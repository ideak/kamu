{% extends "base.html" %}
{% load compress static i18n static %}

{% block content %}
<input id="member-search" class="input-xxlarge" type="text"
	placeholder="{% trans "Filter by name/party/district" %}" />
<ul id="member-list" class="row"></ul>

{% compress js %}
<script type="text/coffeescript" src="{% static "js/models.coffee" %}"></script>
{% endcompress %}

{% compress js %}
<script type="text/coffeescript">
class MemberView extends Backbone.View
    content_template: """
    <a class="portrait-link" href="<%= model.get_view_url() %>">
        <img class="portrait" src="<%= attr.photo_thumbnail %>" />
    </a>
    <div class="member-info">
        <a href="<%= model.get_view_url() %>" class="member-name">
            <%= attr.name %>
        </a>
        <span class="member-district"><%= attr.district_name %></span>
        <span class="member-party"><%= attr.party.full_name %></span>
    </div>
    <ul class="member-stats">
        <li>
            <%= Math.round(attr.stats.party_agree*100) %>%
            <img src="{% static "images/icons/party_agr.png" %}"
                alt="{% trans "Party agreement" %}"
                title="{% trans "Party agreement" %}"
                />
        </li>
        
        <li>
            <%= Math.round(attr.stats.session_agree*100) %>%
            <img src="{% static "images/icons/session_agr.png" %}"
                alt="{% trans "Session agreement" %}"
                title="{% trans "Session agreement" %}"
                />
        </li>
        <li>
            <%= Math.round(attr.stats.attendance*100) %>%
            <img src="{% static "images/icons/attendance.png" %}"
                alt="{% trans "Attendance" %}"
                title="{% trans "Attendance" %}"
                />
        </li>
    </ul>
    """
    
    initialize: =>
        attr = @model.attributes
        @el = $ '<li class="member-list-item span4"></div>'
        @$el = $ @el
        html = _.template @content_template, {model: @model, attr: attr}
        @$el.html html

class MemberListView extends Backbone.View
    el: $ "#member-list"
    

    initialize: ->
        $("#member-list").spin top: 0

        @$el = $ @el
        @children = {}

        @collection = new MemberList
        @collection.bind "add", @append_item
        
        @index = new lunr.Index
        @index.field "name"
        @index.field "party"
        @index.field "district"
        @index.ref "id"
        
        @search_el = $("#member-search")
        @search_el.input @_filter_listing
        
        @collection.fetch
	        success: (col) =>
                @_update_search_hint(col)
                @_filter_listing()
            data:
                thumbnail_dim: "64x96"
                current: true
                limit: 0
            processData: true

    _update_search_hint: (col) =>
        i = Math.floor(Math.random()*(col.models.length))
        a = col.models[i].attributes
        hint = "{% trans ", e.g. " %}" +
            a.given_names.split(" ", 1)[0].split('-', 1)[0].toLowerCase() + " " +
            a.party.full_name.toLowerCase()[..2] + " " +
            a.district_name.toLowerCase()[..3]
        
        $el = $ @search_el
        $el.attr "placeholder", $el.attr("placeholder") + hint
	    
    _filter_listing: =>
        @$el.empty()
        query = @search_el.val()
        if query == ""
            for key of @children
                @$el.append @children[key].el
            return

        result = @index.search query
        for hit in result
            @$el.append(@children[hit.ref].el)
        
    append_item: (model, collection, options) =>
        $("#member-list").spin false
        item_view = new MemberView model: model
        
        $(@el).append item_view.el
        @children[model.id] = item_view
        @index.add
            id: model.id
            name: model.attributes.name
            party: model.attributes.party.full_name
            district: model.attributes.district_name

member_list_view = new MemberListView
</script>
{% endcompress %}



{% endblock %}
