{% extends "opinions/opinion_base.html" %}
{% load i18n thumbnail assets %}
{% block title %}{{ vote_name }} | {% trans "Voting prediction" %}{% endblock %}
{% block head %}
{{ block.super }}
{% assets "raphael" %}
  <script type="text/javascript" src="{{ ASSET_URL }}"></script>
{% endassets %}
<script type="text/javascript">
var mp_list = {{ mp_json|safe }};
var option_list = {{ opt_json|safe }};
var party_list = {{ party_json|safe }};

function draw_bar(element, segments) {
	var height = element.height(), width = element.width();
	var paper = Raphael(element[0], width, height);

	sum = 0;
	for (i = 0; i < segments.length; i++) {
		sum += segments[i].count;
	}
	x = count = 0;
	for (i in segments) {
		s = segments[i];
		count += s.count;
		x_end = Math.round(count * width / sum);
		rect = paper.rect(x, 0, x_end, height);
		if ('color' in s) {
			rect.attr("fill", s.color);
			rect.attr("stroke", s.color);
		}
		// rect.attr("title", "{{ question.text }}");
		x = x_end;
	}
}

function create_mp_entry(mp) {
	var row = document.createElement("tr");
	var cols = []
	var party = party_list[mp.party];

	var html = "<td><img class='party_logo' src='" + party.logo + "' /\></td>";
	html += "<td><img class='portrait' src='" + mp.portrait + "' /\></td>";
	html += "<td><a href='" + mp.url + "'>" + mp.name + "</a></td>"
	if (mp.answer >= 0) {
		color = option_list[mp.answer].color;
		if (color) {
			html += "<span style='color: " + color + "; font-size: 240%;'>";
			html += "&#x25cf";
			html += "</span>"
		}
	}
	row.innerHTML = html;
	return row;
}

$(document).ready(function() {
	function party_sort(mp_a, mp_b) {
		return mp_a.party > mp_b.party;
	}

	var table_for = document.getElementById('members_for');
	var table_against = document.getElementById('members_against');
	var entries_for = [], entries_against = [];
	var counts = [];

	for (i in mp_list) {
		var mp = mp_list[i];
		var party = party_list[mp.party];

		if (!('answer' in mp)) {
			continue;
		}
		if (!('answer_counts' in party)) {
			party.answer_counts = [];
		}
		ac = party.answer_counts;
		if (!(mp.answer in ac)) {
			ac[mp.answer] = 1;
		} else {
			ac[mp.answer]++;
		}
		if (!(mp.answer in counts)) {
			counts[mp.answer] = 1;
		} else {
			counts[mp.answer]++;
		}
		var opt = option_list[mp.answer];
		if (opt.congruence > 0) {
			entries_for.push(mp);
		} else {
			entries_against.push(mp);
		}
	}
	entries_for.sort(party_sort);
	entries_against.sort(party_sort);
	for (i in entries_for) {
		table_for.appendChild(create_mp_entry(entries_for[i]));
	}
	for (i in entries_against) {
		table_against.appendChild(create_mp_entry(entries_against[i]));
	}

	for (i in party_list) {
		var party = party_list[i];
		var segments = [];
		var total = 0;

		for (j in option_list) {
			var opt = option_list[j];
			var seg = [];

			seg.count = party.answer_counts[j];
			if (!seg.count) {
				continue;
			}
			if ('color' in opt) {			
				seg.color = opt.color;
			}
			segments.push(seg);
		}
		var id = "#stats_" + i;
		var el = $(id + ' .opt_stats .bar');
		draw_bar(el, segments);
	}
});
</script>
{% endblock %}
{% block content %}
<h1>
  {% trans "How members would vote on" %} {{vote_name}}?
</h1>
<p>{% blocktrans %}
This page shows how the MPs would vote, if they were to vote according to their stated opinions.
{% endblocktrans %}</p>

{% include "opinions/opinion_vote_table.html" %}

<div style="clear: both; margin-bottom: 2em">
<h3>{% trans "Whole parliament" %}</h2>
{% trans "Yay" %}: {{answers_for|length}}
{% trans "Nay" %}: {{answers_against|length}}
</div>

<h3>{% trans "Parties" %}</h3>
{% for party in parties %}
<div id="stats_{{ party.name }}" class="opinions_party_stats">
  <div class="logo"><img src="{% thumbnail party.logo 32x32 %}" /></div>
  <div class="stats opt_stats">
    <div class="bar"></div>
  </div>
</div>
{% endfor %}

<div class="opinions_mp_list">
  <h3>{% trans "Members for" %}</h3>
  <table id="members_for">
  </table>
</div>

<div class="opinions_mp_list">
  <h3>{% trans "Members against" %}</h3>
  <table id="members_against">
  </table>
</div>

{% endblock %}

